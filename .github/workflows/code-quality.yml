name: Code Quality Checks

permissions:
  contents: write

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  format:
    name: Auto-format source files (Prettier + ESLint --fix)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install TypeScript + ESLint ecosystem (CI only)
        run: |
          # Install everything needed for TypeScript parsing
          npm install --no-save \
            typescript \
            eslint \
            @typescript-eslint/parser \
            @typescript-eslint/eslint-plugin \
            eslint-plugin-react \
            eslint-plugin-react-hooks \
            eslint-plugin-jsx-a11y \
            eslint-config-prettier \
            prettier

      - name: Find tracked source files
        id: find_files
        run: |
          # Find tracked JS/TS files and save to temp file
          git ls-files 'app/**/*.[jt]s' 'app/**/*.[jt]sx' 'lib/**/*.[jt]s' 'lib/**/*.[jt]sx' 'src/**/*.[jt]s' 'src/**/*.[jt]sx' > files.txt || true

          if [ ! -s files.txt ]; then
            echo "No tracked source files found."
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "Found $(wc -l < files.txt) source files"
          fi

      - name: Run Prettier on tracked files (if any)
        if: steps.find_files.outputs.has_files == 'true'
        run: |
          if [ ! -s files.txt ]; then
            echo "No tracked files found for Prettier. Skipping."
            exit 0
          fi

          echo "Running Prettier on tracked files (showing first 10):"
          head -10 files.txt

          # Run prettier with files from file
          cat files.txt | xargs npx prettier --write || true

      - name: Run ESLint --fix (tracked files, robust)
        if: steps.find_files.outputs.has_files == 'true'
        id: autofix
        run: |
          if [ ! -s files.txt ]; then
            echo "No tracked source files to run eslint --fix on."
            exit 0
          fi

          # Try to fix all files at once first
          cat files.txt | xargs npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern || true

          # Then try per-file for any that failed
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Attempting per-file fix: $file"
              if ! npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern "$file" 2>&1; then
                echo "$file" >> eslint-failures.txt || true
              fi
            fi
          done < files.txt

          if [ -f eslint-failures.txt ] && [ -s eslint-failures.txt ]; then
            echo "ESLint failed to auto-fix these files:"
            head -200 eslint-failures.txt || true
            echo "::error::ESLint crashed or cannot fix some files. See eslint-failures.txt"
            exit 1
          fi

      - name: Show changes made by auto-fix (for debugging)
        run: |
          git --no-pager status --porcelain || true
          echo "---- DIFF ----"
          git -c color.ui=false --no-pager diff || true

      - name: Commit & push formatted changes (if any)
        if: steps.autofix.outcome == 'success' && steps.find_files.outputs.has_files == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
          message: "chore: auto-format source files (CI)"
          add: "app lib src package.json package-lock.json yarn.lock"
          push: "true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: ESLint (source-only, warnings ignored)
    runs-on: ubuntu-latest
    needs: format

    steps:
      - name: Checkout code (sync latest branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure latest branch (pick up formatting commit if pushed)
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          git fetch origin "$BRANCH" || true
          git reset --hard "origin/$BRANCH" || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install TypeScript + ESLint ecosystem (CI only)
        run: |
          # Install everything needed for TypeScript parsing
          npm install --no-save \
            typescript \
            eslint \
            @typescript-eslint/parser \
            @typescript-eslint/eslint-plugin \
            eslint-plugin-react \
            eslint-plugin-react-hooks \
            eslint-plugin-jsx-a11y \
            eslint-config-prettier \
            prettier

      - name: Find tracked source files (for lint)
        id: find_lint_files
        run: |
          git ls-files 'app/**/*.[jt]s' 'app/**/*.[jt]sx' 'lib/**/*.[jt]s' 'lib/**/*.[jt]sx' 'src/**/*.[jt]s' 'src/**/*.[jt]sx' > lint-files.txt || true
          
          if [ ! -s lint-files.txt ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "Found $(wc -l < lint-files.txt) source files to lint"
          fi

      - name: Run ESLint (errors fail, warnings ignored)
        if: steps.find_lint_files.outputs.has_files == 'true'
        run: |
          cat lint-files.txt | xargs npx eslint --quiet --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern

      - name: Skip lint if no source files found
        if: steps.find_lint_files.outputs.has_files == 'false'
        run: echo "No source files found (app/, lib/, src/). Skipping ESLint."

  test:
    name: Jest Tests
    runs-on: ubuntu-latest
    needs: format

    steps:
      - name: Checkout code (sync latest branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure latest branch (pick up formatting commit if pushed)
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          git fetch origin "$BRANCH" || true
          git reset --hard "origin/$BRANCH" || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          CI: true

          