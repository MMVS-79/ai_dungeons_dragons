name: Code Quality Checks

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  quality-checks:
    name: Format, Lint, and Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install TypeScript + ESLint ecosystem (CI only)
        run: |
          # Install everything needed for TypeScript parsing
          npm install --no-save \
            typescript \
            eslint \
            @typescript-eslint/parser \
            @typescript-eslint/eslint-plugin \
            eslint-plugin-react \
            eslint-plugin-react-hooks \
            eslint-plugin-jsx-a11y \
            eslint-config-prettier \
            prettier

      - name: Find tracked source files
        id: find_files
        run: |
          # Find tracked JS/TS files and save to temp file
          git ls-files 'app/**/*.[jt]s' 'app/**/*.[jt]sx' 'lib/**/*.[jt]s' 'lib/**/*.[jt]sx' 'src/**/*.[jt]s' 'src/**/*.[jt]sx' > files.txt || true

          if [ ! -s files.txt ]; then
            echo "No tracked source files found."
            echo "has_files=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "Found $(wc -l < files.txt) source files"
          fi

      - name: Run Prettier on tracked files (if any)
        if: steps.find_files.outputs.has_files == 'true'
        run: |
          if [ ! -s files.txt ]; then
            echo "No tracked files found for Prettier. Skipping."
            exit 0
          fi

          echo "Running Prettier on tracked files (showing first 10):"
          head -10 files.txt

          # Run prettier with files from file
          cat files.txt | xargs npx prettier --write || true

      - name: Run ESLint --fix (tracked files, robust)
        if: steps.find_files.outputs.has_files == 'true'
        id: autofix
        run: |
          if [ ! -s files.txt ]; then
            echo "No tracked source files to run eslint --fix on."
            exit 0
          fi

          # Try to fix all files at once first
          cat files.txt | xargs npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern || true

          # Then try per-file for any that failed
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Attempting per-file fix: $file"
              if ! npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern "$file" 2>&1; then
                echo "$file" >> eslint-failures.txt || true
              fi
            fi
          done < files.txt

          if [ -f eslint-failures.txt ] && [ -s eslint-failures.txt ]; then
            echo "ESLint failed to auto-fix these files:"
            head -200 eslint-failures.txt || true
            echo "::error::ESLint crashed or cannot fix some files. See eslint-failures.txt"
            exit 1
          fi

      - name: Show changes made by auto-fix (for debugging)
        run: |
          git --no-pager status --porcelain || true
          echo "---- DIFF ----"
          git -c color.ui=false --no-pager diff || true

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "chore: auto-format source files (Prettier + ESLint)"
          git push

      - name: Comment on PR
        if: steps.git-check.outputs.changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✨ Code has been auto-formatted with Prettier and ESLint!'
            })

      # Now lint and test the formatted code
      - name: Run ESLint (errors fail, warnings ignored)
        if: steps.find_files.outputs.has_files == 'true'
        run: |
          echo "Linting $(wc -l < files.txt) files..."
          
          if cat files.txt | xargs npx eslint --quiet --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern; then
            echo "✅ ESLint passed - no errors found!"
          else
            echo "❌ ESLint failed - errors found above"
            exit 1
          fi

      - name: Run tests
        continue-on-error: true
        run: npm test
        env:
          CI: true

          