name: Code Quality Checks

permissions:
  contents: write

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  format:
    name: Auto-format source files (Prettier + ESLint --fix)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Find tracked source files
        id: find_files
        run: |
          # Look for tracked JS/TS files under the common source dirs
          FILES="$(git ls-files 'app/**/*.[jt]s' 'app/**/*.[jt]sx' 'lib/**/*.[jt]s' 'lib/**/*.[jt]sx' 'src/**/*.[jt]s' 'src/**/*.[jt]sx' || true)"
          echo "::set-output name=files::$FILES"

      - name: Run Prettier on tracked files (if any)
        if: steps.find_files.outputs.files != ''
        run: |
          # NUL-safe: list tracked source files and run prettier on them
          git ls-files -z 'app/**/*.{js,ts,jsx,tsx}' 'lib/**/*.{js,ts,jsx,tsx}' 'src/**/*.{js,ts,jsx,tsx}' \
            | xargs -0 -r npx prettier --write || true

      - name: Run ESLint --fix (tracked files, robust)
        if: steps.find_files.outputs.files != ''
        id: autofix
        run: |
          set -euo pipefail
          # Use the actual tracked files to avoid ESLint "no files match pattern" errors.
          printf "%s\n" "${{ steps.find_files.outputs.files }}" \
            | xargs -r npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern || true

          # If eslint --fix above failed/crashed, attempt per-file to surface problematic files.
          # (We allow the above to exit non-zero without failing the step so we can inspect.)
          printf "%s\n" "${{ steps.find_files.outputs.files }}" | while read -r file; do
            if ! npx eslint --fix --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern "$file"; then
              echo "ESLINT_FIX_FAILED:$file" >> eslint-failures.txt || true
            fi
          done

          if [ -f eslint-failures.txt ] && [ -s eslint-failures.txt ]; then
            echo "ESLint failed to auto-fix these files:"
            sed -n '1,200p' eslint-failures.txt || true
            echo "::error::ESLint crashed or cannot fix some files. See eslint-failures.txt"
            exit 1
          fi

      - name: Show changes made by auto-fix (for debugging)
        run: |
          git --no-pager status --porcelain || true
          echo "---- DIFF ----"
          git -c color.ui=false --no-pager diff || true

      - name: Commit & push formatted changes (if any)
        if: steps.autofix.outcome == 'success' && steps.find_files.outputs.files != ''
        uses: EndBug/add-and-commit@v9
        with:
          author_name: "github-actions[bot]"
          author_email: "41898282+github-actions[bot]@users.noreply.github.com"
          message: "chore: auto-format source files (CI)"
          add: "app lib src package.json package-lock.json yarn.lock"
          push: "true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: ESLint (source-only, warnings ignored)
    runs-on: ubuntu-latest
    needs: format

    steps:
      - name: Checkout code (sync latest branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure latest branch (pick up formatting commit if pushed)
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          git fetch origin "$BRANCH" || true
          git reset --hard "origin/$BRANCH" || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Find tracked source files (for lint)
        id: find_lint_files
        run: |
          FILES="$(git ls-files 'app/**/*.[jt]s' 'app/**/*.[jt]sx' 'lib/**/*.[jt]s' 'lib/**/*.[jt]sx' 'src/**/*.[jt]s' 'src/**/*.[jt]sx' || true)"
          echo "::set-output name=files::$FILES"

      - name: Run ESLint (errors fail, warnings ignored)
        if: steps.find_lint_files.outputs.files != ''
        run: |
          # Use --quiet to suppress warnings; add --no-error-on-unmatched-pattern to avoid
          # "No files matching the pattern" CLI error in case a pattern is empty.
          printf "%s\n" "${{ steps.find_lint_files.outputs.files }}" \
            | xargs -r npx eslint --quiet --ext .js,.jsx,.ts,.tsx --no-error-on-unmatched-pattern

      - name: Skip lint if no source files found
        if: steps.find_lint_files.outputs.files == ''
        run: echo "No source files found (app/, lib/, src/). Skipping ESLint."

  test:
    name: Jest Tests
    runs-on: ubuntu-latest
    needs: format

    steps:
      - name: Checkout code (sync latest branch)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure latest branch (pick up formatting commit if pushed)
        run: |
          BRANCH="${{ github.head_ref || github.ref_name }}"
          git fetch origin "$BRANCH" || true
          git reset --hard "origin/$BRANCH" || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          CI: true

          